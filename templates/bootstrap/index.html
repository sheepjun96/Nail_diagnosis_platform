<!DOCTYPE html>
<html lang="en">

{% include "includes/head.html" %}

<body id="page-top" class="d-flex flex-column min-vh-100">

    <!-- Page Wrapper -->
    <div id="wrapper">

        {% include "includes/sidebar.html" %}

        <!-- Content Wrapper -->
        <div id="content-wrapper" class="d-flex flex-column">

            <!-- Main Content -->
            <div id="content">

                {% include "includes/topbar.html" %}

                <!-- Begin Page Content -->
                <div class="container-fluid d-flex flex-column flex-grow-1" style="height: calc(100% - 70px) !important;">
                    <!-- Page Heading -->
                    <div class="d-sm-flex align-items-center justify-content-between mb-4">
                        <h1 class="h3 mb-0 text-gray-100 font-weight-bold project-title">Main Project</h1>
                        <div class="text-gray-300 small">
                           <i class="fa fa-clipboard-list"></i> Project > Main Project
                        </div>
                    </div>

                    <!-- Content Row -->
                    <div class="row container-fluid h-100">
                        <div class="col-8 h-100" >
                            <div class="row h-100" style="display:block;">
                                <div class="container-fluid col-lg-12 mb-4 bg-bg2 card search-div " >
                                    <form
                                        class="d-none d-sm-inline-block form-inline mr-auto ml-md-3 my-2 my-md-0 mw-100 w-100 navbar-search">
                                        <table class="text-white mw-100" style="width:80%">
                                            <tbody>
                                                <tr>
                                                    <td style="width:120px;">Search</td>
                                                    <td style="width:80%">
                                                        <div class="input-group">
                                                            <input type="text" id="main_search_input" class="form-control bg-bg2 text-white border-1 small" placeholder=""
                                                                aria-label="Search" aria-describedby="basic-addon2">
                                                            <div class="input-group-append">
                                                                <button class="btn btn-accent" type="button">
                                                                    <i class="fas fa-search fa-sm"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </form>
                                </div>

                                <div class="container-fluid col-lg-12 mb-4 bg-bg2 card search-div" style="height: calc(100% - 100px);">
                                    <div class="preview-div text-right">
                                        <a class="btn btn-sm btn-secondary fa-xs"  href="/app/add" ><i class="fas fa-plus text-white"></i> Add</a>
                                    </div>
                                    <table class="table text-center text-white fa-xs" width="100%" cellspacing="0">
                                        <thead>
                                            <tr>
                                                <th class="bg-bg3">No</th>
                                                <th class="bg-bg3">Status</th>
                                                <th class="bg-bg3">Patient ID</th>
                                                <th class="bg-bg3">Patient Name</th>
                                                <th class="bg-bg3">Gender</th>
                                                <th class="bg-bg3">Birthday</th>
                                                <th class="bg-bg3">Imported At</th>
                                                <th class="bg-bg3">Study Date</th>
                                                <th class="bg-bg3">Tags</th>
                                                <th class="bg-bg3">Readdate</th>
                                            </tr>
                                        </thead>
                                        <tbody id="main_resource_list">
                                            <tr class="bg-accent">
                                                <td>1</td>
                                                <th>-</th>
                                                <th>ANO_123456</th>
                                                <td>Tiger Nixon</td>
                                                <td>M</td>
                                                <td>1996/04/25(29)</td>
                                                <td>2025/10/10</td>
                                                <td>2025/06/24</td>
                                                <td><span class="badge badge-success">Normal</span></td>
                                                <td>-</td>
                                            </tr>
                                            <tr>
                                                <td>2</td>
                                                <th>-</th>
                                                <th>ANO_123457</th>
                                                <td>Tiger Nixon</td>
                                                <td>M</td>
                                                <td>1996/04/25(29)</td>
                                                <td>2025/10/10</td>
                                                <td>2025/06/24</td>
                                                <td><span class="badge badge-success">Normal</span></td>
                                                <td>-</td>
                                            </tr>
                                            <tr>
                                                <td>3</td>
                                                <th>-</th>
                                                <th>ANO_123456</th>
                                                <td>Tiger Nixon</td>
                                                <td>M</td>
                                                <td>1996/04/25(29)</td>
                                                <td>2025/10/10</td>
                                                <td>2025/06/24</td>
                                                <td><span class="badge badge-success">Normal</span></td>
                                                <td>-</td>
                                            </tr>
                                            
                                        </tbody>
                                    </table>
                                </div>

                            </div>
                        </div>

                        <div class="col-4 h-100" >
                            <div class="col-lg-12 mb-4 bg-bg2 card search-div d-flex justify-content-between" style="height: calc(100% - 20px);">
                                <div>
                                    <div class="preview-div">
                                        <h4 class="sub-title">Series List</h4>
                                        <table class="table text-center text-white fa-xs" width="100%" cellspacing="0">
                                            <thead>
                                                <tr>
                                                    <th>No</th>
                                                    <th>date</th>
                                                    <th>instance</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr class="bg-accent">
                                                    <td>1</td>
                                                    <td>2025/10/21</td>
                                                    <td>4</td>
                                                </tr>
                                                <tr>
                                                    <td>2</td>
                                                    <td>2025/10/20</td>
                                                    <td>4</td>
                                                </tr>
                                                <tr>
                                                    <td>3</td>
                                                    <td>2025/10/18</td>
                                                    <td>4</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="preview-div">
                                        <h4 class="sub-title">Preview</h4>
                                        <table class="table text-center text-white fa-xs" width="100%" cellspacing="0">
                                            <tbody>
                                                <tr class="bg-bg3">
                                                    <th>L Thumb</th>
                                                    <th>L Index</th>
                                                    <th>L Middle</th>
                                                    <th>L Ring</th>
                                                    <th>L Pinky</th>
                                                </tr>
                                                <tr>
                                                    <td style="width: 20%;height:60px;"><img src="/static/patient_images/1/2025-07-03/cropped_nail/left_thumb.png" height="60px" /></td>
                                                    <td style="width: 20%;height:60px;"><img src="/static/patient_images/1/2025-07-03/cropped_nail/left_index.png" height="60px" /></td>
                                                    <td style="width: 20%;height:60px;"><img src="/static/patient_images/1/2025-07-03/cropped_nail/left_middle.png" height="60px" /></td>
                                                    <td style="width: 20%;height:60px;"><img src="/static/patient_images/1/2025-07-03/cropped_nail/left_ring.png" height="60px" /></td>
                                                    <td style="width: 20%;height:60px;"><img src="/static/patient_images/1/2025-07-03/cropped_nail/left_pinky.png" height="60px" /></td>
                                                </tr>
                                                <tr>
                                                    <td style="width: 20%;height:60px;"><span>No extra</span></td>
                                                    <td style="width: 20%;height:60px;"><span>No extra</span></td>
                                                    <td style="width: 20%;height:60px;"><span>No extra</span></td>
                                                    <td style="width: 20%;height:60px;"><span>No extra</span></td>
                                                    <td style="width: 20%;height:60px;"><span>No extra</span></td>
                                                </tr>
                                                <tr class="bg-bg3">
                                                    <th>R Thumb</th>
                                                    <th>R Index</th>
                                                    <th>R Middle</th>
                                                    <th>R Ring</th>
                                                    <th>R Pinky</th>
                                                </tr>
                                                <tr>
                                                    <td style="width: 20%;height:60px;"><img src="/static/patient_images/1/2025-07-03/cropped_nail/right_thumb.png" height="60px" /></td>
                                                    <td style="width: 20%;height:60px;"><img src="/static/patient_images/1/2025-07-03/cropped_nail/right_index.png" height="60px" /></td>
                                                    <td style="width: 20%;height:60px;"><img src="/static/patient_images/1/2025-07-03/cropped_nail/right_middle.png" height="60px" /></td>
                                                    <td style="width: 20%;height:60px;"><img src="/static/patient_images/1/2025-07-03/cropped_nail/right_ring.png"  height="60px" /></td>
                                                    <td style="width: 20%;height:60px;"><img src="/static/patient_images/1/2025-07-03/cropped_nail/right_pinky.png" height="60px" /></td>
                                                </tr>
                                                <tr>
                                                    <td style="width: 20%;height:60px;"><span>No extra</span></td>
                                                    <td style="width: 20%;height:60px;"><span>No extra</span></td>
                                                    <td style="width: 20%;height:60px;"><span>No extra</span></td>
                                                    <td style="width: 20%;height:60px;"><span>No extra</span></td>
                                                    <td style="width: 20%;height:60px;"><span>No extra</span></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="w-100">
                                    <a class="btn btn-secondary w-100" href="/app/viewer">Viewer</a>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                <!-- /.container-fluid -->

            </div>
            <!-- End of Main Content -->

            {% include "includes/footer.html" %}

        </div>
        <!-- End of Content Wrapper -->

    </div>
    <!-- End of Page Wrapper -->

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            loadStudyList();
        });
        
        async function loadStudyList() {
            try {
                const res = await fetch("/api/resource/study/list", {
                method: "GET",
                headers: {
                    "Accept": "application/json"
                }
                });

                if (!res.ok) {
                console.error("API 응답 오류:", res.status, res.statusText);
                return;
                }

                const data = await res.json();

                if (data.code !== 200) {
                console.error("API 응답 코드 에러:", data);
                return;
                }

                const tbody = document.getElementById("main_resource_list");
                if (!tbody) {
                console.error("tbody#main_resource_list 를 찾을 수 없습니다.");
                return;
                }

                // 기존 목록 초기화
                tbody.innerHTML = "";

                const items = data.context || [];

                items.forEach((row, index) => {
                const tr = document.createElement("tr");

                // 날짜 포맷 간단 처리 (null 방지)
                const birth = row.stl_patient_birthdate
                    ? row.stl_patient_birthdate.substring(0, 10)
                    : "";
                const studyDate = row.stl_patient_studydate
                    ? row.stl_patient_studydate.replace("T", " ").substring(0, 19)
                    : "";
                const recentDate = row.stl_patient_recentdate
                    ? row.stl_patient_recentdate.replace("T", " ").substring(0, 19)
                    : "";

                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${row.stl_patient_status ?? ""}</td>
                    <td>${row.stl_patient_id ?? ""}</td>
                    <td>${row.stl_patient_name ?? ""}</td>
                    <td>${row.stl_patient_gender ?? ""}</td>
                    <td>${birth}</td>
                    <td>${studyDate}</td>
                    <td>${recentDate}</td>
                    <td>${row.stl_patient_tag ?? ""}</td>
                `;

                tbody.appendChild(tr);
                });

            } catch (err) {
                console.error("study list 로딩 중 에러:", err);
            }
            }
    </script>

    {% include "includes/scrollbutton.html" %}

    {% include "includes/scripts.html" %}

</body>

</html>